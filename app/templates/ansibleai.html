{% extends "base.html" %}

{% block title %}Ansible AI{% endblock %}

{% block content %}

<!-- Tailwind CSS CDN -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<div id="ai-chat-container" class="hidden">
<div class="flex flex-col h-screen">
    <div class="mx-auto w-full" style="width: 80vw;">
        <div class="bg-white shadow-lg rounded-lg flex flex-col max-h-screen">
            <div class="p-4 border-b border-gray-200 flex-none">
                <div class="flex items-center">
                    <img src="{{ url_for('static', filename='logo.jpeg')}}" class="rounded-full h-12 w-12">
                    <span class="ml-2 text-lg text-gray-700">AI Ops</span>
                    <div class="ml-auto">
                        <span>Let's talk Tech!</span>
                    </div>
                </div>
            </div>
            <div id="messageFormeight" class="flex-auto p-4 overflow-y-auto" style="max-height: calc(100vh - 200px);">
                <!-- Messages will be appended here -->
            </div>
            <div class="p-4 flex-none">
                <form id="messageArea" class="flex">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="text" id="text" name="msg" placeholder="Type your message..." autocomplete="off" class="flex-1 p-2 border rounded focus:outline-none focus:shadow-outline" required />
                    <button type="submit" id="send" class="ml-2 p-2 bg-blue-500 text-white rounded" onclick="loading()">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
</div>



<script>
    $(document).ready(function() {
		$("#messageArea").on("submit", function(event) {
			event.preventDefault();
			loading();
			const date = new Date();
			const hour = date.getHours();
			const minute = date.getMinutes();
			const str_time = hour + ":" + minute;
			var rawText = $("#text").val();
			var userHtml = '<div class="flex justify-end mb-4"><div class="bg-gray-300 p-2 rounded">' + rawText + '<span class="text-sm text-gray-600">' + str_time + '</span></div></div>';
			
			$("#text").val("");
			$("#messageFormeight").append(userHtml);
			
			fetch('/chat', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
					'X-CSRFToken': $('input[name="csrf_token"]').val()
				},
				body: 'msg=' + encodeURIComponent(rawText) + '&csrf_token=' + encodeURIComponent($('input[name="csrf_token"]').val())
			}).then(response => {
				const reader = response.body.getReader();
				return new ReadableStream({
					start(controller) {
						function push() {
							reader.read().then(({done, value}) => {
								if (done) {
									controller.close();
									return;
								}
								controller.enqueue(value);
								push();
							}).catch(error => {
								console.error(error);
								controller.error(error);
							});
						}
						push();
					}
				});
			}).then(stream => {
				return new Response(stream);
			}).then(response => {
				return response.text();
			}).then(data => {
				var formattedData = formatResponse(data);
				var botHtml = '<div class="flex justify-start mb-4"><div class="bg-blue-100 p-2 rounded">' + formattedData + '<span class="text-sm text-gray-600">' + str_time + '</span></div></div>';
				$("#messageFormeight").append($.parseHTML(botHtml));
				hideLoading();
				adjustChatHeight();
			}).catch(error => {
				console.error('Fetch error:', error);
				hideLoading();
			});
		});
		// ... rest of your code ...
	});

	function adjustChatHeight() {
		var messageFormeight = document.getElementById('messageFormeight');
		var newHeight = messageFormeight.scrollHeight > 200 ? messageFormeight.scrollHeight : 200; // Minimum height 200px
		if (newHeight > window.innerHeight * 0.6) { // Max height 60% of viewport height
			newHeight = window.innerHeight * 0.6;
		}
		messageFormeight.style.height = newHeight + 'px';
	}
	
	function formatResponse(data) {
		// Simple example of formatting based on cues
		data = data.replace(/(?:\d+\.\s*\*\*)([^\*]+)(\*\*)/g, '<li>$1</li>'); // Convert numbered items into list items
		data = data.replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>'); // Convert triple backticks into code blocks
		return '<ol>' + data + '</ol>'; // Wrap in ordered list
	}

	window.onload = function() {
        document.getElementById('loading-spinner').classList.remove('hidden');
        loadChat(); // Call a function to load the chat
    };

	function loadChat() {
        // Simulate chat loading with a timeout (replace this with actual chat loading logic)
        setTimeout(function() {
            // Once chat is ready, hide the spinner and show the chat container
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('ai-chat-container').classList.remove('hidden');
        }, 3000); // Replace with actual chat load completion event
    }
	
	function loading() {
        // Show the spinner
        document.getElementById('loading-spinner').classList.remove('hidden');
    }
    
    function hideLoading() {
        // Hide the spinner
        document.getElementById('loading-spinner').classList.add('hidden');
    }
	
</script>

{% endblock %}